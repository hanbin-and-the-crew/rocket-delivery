<configuration>

    <springProperty scope="context" name="serviceName" source="spring.application.name"/>

    <!-- Logstash 로그  -->
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>localhost:5044</destination>

        <!-- 재연결 시도 간격(3초) -->
        <reconnectionDelay>3000</reconnectionDelay>

        <!-- JSON 로그에 serviceName 필드 추가 -->
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"serviceName":"${serviceName}"}</customFields>
        </encoder>

    </appender>

    <!-- 비동기 로깅 (ELK 장애가 있어도 절대 block되지 않음) -->
    <appender name="ASYNC_LOGSTASH" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="LOGSTASH"/>

        <!-- 큐 사이즈: 버퍼 -->
        <queueSize>1000</queueSize>

        <!-- ELK 죽어도 어플리케이션(모듈)은 돌아가도록 -->
        <neverBlock>true</neverBlock>
    </appender>

    <!-- Local 로그  -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!--<pattern>${CONSOLE_LOG_PATTERN}</pattern>-->
            <pattern>%cyan(%d{yyyy-MM-dd'T'HH:mm:ss.SSSXXX}) %highlight(%-5level) %green(%logger{36}) - %msg%n</pattern>
        </encoder>
    </appender>

    <root level="INFO">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="ASYNC_LOGSTASH"/>
    </root>

</configuration>